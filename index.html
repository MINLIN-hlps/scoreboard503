<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­¸ç”Ÿç°¡å ±è©•åˆ†ç³»çµ±</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f0f0f0;
    }
    h2 {
      color: #333;
    }
    .student {
      margin-bottom: 20px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .score-input {
      width: 50px;
    }
    .average {
      font-weight: bold;
      color: green;
    }
    .score-list {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
    #login-section {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius:  10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    #export-button, #submit-to-google-button {
      margin-top: 10px;
      padding: 10px 15px;
      font-size: 16px;
    }
    #teacher-summary {
      margin-top: 30px;
      background: #fff9e6;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>å­¸ç”Ÿç°¡å ±å³æ™‚è©•åˆ†ç³»çµ±</h2>

  <div id="login-section">
    <label for="studentId">è«‹é¸æ“‡ä½ çš„åº§è™Ÿï¼š</label>
    <select id="studentId">
      <option value="">-- è«‹é¸æ“‡ --</option>
    </select>
    <button onclick="confirmStudentId()">é–‹å§‹è©•åˆ†</button>
  </div>

  <div id="container" style="display: none;"></div>
  <button id="export-button" style="display: none;" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡ºæ‰€æœ‰è©•åˆ† (Excel)</button>

  <div id="teacher-summary" style="display: none;">
    <h3>ğŸ‘©â€ğŸ« è€å¸«å°ˆç”¨è©•åˆ†çµ±è¨ˆ</h3>
    <div id="teacher-stats"></div>
  </div>

  <script>
    const studentNumbers = [2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15, 16, 17, 18];
    const scores = {};
    const submissions = {};
    let currentStudentId = null;
    const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxaPvbx7KHI_rb1CC8v3pQhY6GXeBPzcXrYhyUU1fIcuEAN1Q8ENio5OhL80toYOWCL/exec";

    const studentIdSelect = document.getElementById('studentId');
    [0, ...studentNumbers].forEach(num => {
      const option = document.createElement('option');
      option.value = num;
      option.textContent = `${num === 0 ? 'è€å¸«ï¼ˆ0è™Ÿï¼‰' : num + ' è™Ÿ'}`;
      studentIdSelect.appendChild(option);
    });

    function confirmStudentId() {
      const selected = studentIdSelect.value;
      if (!selected) {
        alert('è«‹å…ˆé¸æ“‡ä½ çš„åº§è™Ÿå†é–‹å§‹è©•åˆ†');
        return;
      }
      currentStudentId = parseInt(selected);
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('container').style.display = 'block';
      document.getElementById('export-button').style.display = 'inline-block';
      if (currentStudentId === 0) {
        document.getElementById('teacher-summary').style.display = 'block';
        updateTeacherStats();
      }
      renderScoringUI();
    }

    function renderScoringUI() {
      const container = document.getElementById('container');
      container.innerHTML = '';
      studentNumbers.forEach(num => {
        scores[num] = scores[num] || [];
        submissions[num] = submissions[num] || {};
        const div = document.createElement('div');
        div.className = 'student';
        div.innerHTML = `
          <h3>å­¸ç”Ÿ ${num} è™Ÿ</h3>
          <input class="score-input" type="number" min="0" max="10" id="input-${num}" placeholder="0~10"> 
          <button onclick="addScore(${num})">é€å‡ºè©•åˆ†</button>
          <p>å¹³å‡åˆ†æ•¸ï¼š<span class="average" id="avg-${num}">å°šç„¡è©•åˆ†</span></p>
          <div class="score-list" id="list-${num}">ç›®å‰è©•åˆ†ï¼šç„¡</div>
        `;
        container.appendChild(div);
      });
    }

    function addScore(num) {
      const input = document.getElementById(`input-${num}`);
      const value = parseFloat(input.value);
      if (!isNaN(value) && value >= 0 && value <= 10) {
        if (parseInt(num) === parseInt(currentStudentId)) {
          alert('ä¸èƒ½å¹«è‡ªå·±è©•åˆ†å–”ï¼');
          return;
        }
        if (submissions[num][currentStudentId] !== undefined) {
          alert('ä½ å·²ç¶“è©•éé€™ä½åŒå­¸å›‰ï¼');
          return;
        }
        submissions[num][currentStudentId] = value;
        scores[num] = Object.values(submissions[num]);
        const avg = (scores[num].reduce((a, b) => a + b, 0) / scores[num].length).toFixed(2);
        document.getElementById(`avg-${num}`).textContent = `${avg} åˆ†ï¼ˆå…± ${scores[num].length} äººè©•åˆ†ï¼‰`;
        document.getElementById(`list-${num}`).textContent = `ç›®å‰è©•åˆ†ï¼š${Object.entries(submissions[num]).map(([k, v]) => `${k}è™Ÿ: ${v}`).join(', ')}`;
        input.value = '';

        if (currentStudentId === 0) updateTeacherStats();

        fetch(googleScriptUrl, {
          method: "POST",
          body: JSON.stringify([{ rater: currentStudentId, target: num, score: value }]),
          headers: { "Content-Type": "application/json" }
        })
          .then(response => response.text())
          .then(result => console.log("å·²é€å‡ºè‡³ Google è©¦ç®—è¡¨ï¼š", result))
          .catch(error => console.error("é€å‡ºå¤±æ•—ï¼š", error));
      } else {
        alert('è«‹è¼¸å…¥ 0~10 çš„åˆ†æ•¸');
      }
    }

    function updateTeacherStats() {
      const container = document.getElementById('teacher-stats');
      container.innerHTML = '';
      studentNumbers.forEach(num => {
        const score = submissions[num][0];
        if (score !== undefined) {
          const div = document.createElement('div');
          div.textContent = `å­¸ç”Ÿ ${num} è™Ÿï¼šè€å¸«è©•åˆ† ${score} åˆ†`;
          container.appendChild(div);
        }
      });
    }

    function exportToExcel() {
      let csvContent = 'data:text/csv;charset=utf-8,\uFEFF';
      csvContent += 'è©•åˆ†è€…,è¢«è©•è€…,åˆ†æ•¸\n';

      studentNumbers.forEach(target => {
        const ratingObj = submissions[target];
        for (const rater in ratingObj) {
          csvContent += `${rater},${target},${ratingObj[rater]}\n`;
        }
      });

      csvContent += '\nå¹³å‡åˆ†æ•¸å½™ç¸½\n';
      studentNumbers.forEach(target => {
        if (scores[target] && scores[target].length > 0) {
          const avg = (scores[target].reduce((a, b) => a + b, 0) / scores[target].length).toFixed(2);
          csvContent += `${target}è™Ÿ,${avg}\n`;
        }
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', 'å­¸ç”Ÿè©•åˆ†çµæœ.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
